#!/usr/bin/env bash

###############################################################################
# Check requirements
requirements_ok=1
for app in 'wget' 'tar' 'git' 'php5'
do
    installed=`which $app`
    if [[ ! -x $installed ]]
    then
        echo "Missing requirement $app."
        requirements_ok=0
    fi
done
if [[ $requirements_ok != 1 ]]
then
    echo "Bootstrap error: cannot continue due to missing requirements. Please check the list above."
    exit 1
fi

###############################################################################
# Initializations and settings

# Initialize working directory variable
DISTRIBUTION_BASE_DIR="$(dirname $(readlink -f ${BASH_SOURCE[0]}))"
DISTRIBUTION_BASE_DIR="$(dirname $DISTRIBUTION_BASE_DIR)"

PREVIOUS_PWD=$(pwd)

DRUSH_VERSION="4.4" # TODO: get the latest version by default
                    # TODO: read the required version in configuration file
DRUSH_URL="http://ftp.drupal.org/files/projects/drush-7.x-$DRUSH_VERSION.tar.gz"
DRUSH_MAKE_VERSION="2.2"
DRUSH_MAKE_URL="http://ftp.drupal.org/files/projects/drush_make-6.x-$DRUSH_MAKE_VERSION.tar.gz"

# Initializes distribution directory structure and base tools
cd $DISTRIBUTION_BASE_DIR

# Initialize distribution directory structure
mkdir lib
mkdir var var/tmp

###############################################################################
# Libraries
# Download and install libraries:
# * drush
# * drush_make

# Download and install drush
wget $DRUSH_URL -O var/tmp/drush.tar.gz
tar -xzf var/tmp/drush.tar.gz -C lib
rm var/tmp/drush.tar.gz

# Download and install drush_make
wget $DRUSH_MAKE_URL -O var/tmp/drush_make.tar.gz
tar -xzf var/tmp/drush_make.tar.gz -C lib
ln -s $DISTRIBUTION_BASE_DIR/parts/drush_make $DISTRIBUTION_BASE_DIR/lib/drush/commands/drush_make
rm var/tmp/drush_make.tar.gz

# Install custom drush in bin/
# Here we generate it, but it could be downloaded from somewhere.
# Important part is the --root option
echo "#!/usr/bin/env bash" > bin/drush
echo "DISTRIBUTION_BASE_DIR=\"\$(dirname \$(readlink -f \${BASH_SOURCE[0]}))\"" >> bin/drush
echo "DISTRIBUTION_BASE_DIR=\"\$(dirname \$DISTRIBUTION_BASE_DIR)\"" >> bin/drush
echo "\$DISTRIBUTION_BASE_DIR/parts/drush/drush --root=\$DISTRIBUTION_BASE_DIR/www \$@" >> bin/drush
chmod +x bin/drush

cd $PREVIOUS_PWD
