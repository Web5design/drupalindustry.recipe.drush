#!/usr/bin/env bash

# Build the distribution.
# Should be a sub-command like bin/distribution build

# Initialize working directory variable
DISTRIBUTION_BASE_DIR="$(dirname $(readlink -f ${BASH_SOURCE[0]}))"
DISTRIBUTION_BASE_DIR="$(dirname $DISTRIBUTION_BASE_DIR)"

PREVIOUS_PWD=$(pwd)

cd $DISTRIBUTION_BASE_DIR

# Prevent multiple installations
PROJECT_DOWNLOADED=0
if [[ -d www ]]
then
    PROJECT_DOWNLOADED=1
fi

PROJECT_INSTALLED=0
if [[ -f www/sites/default/settings.php ]]
then
    PROJECT_INSTALLED=1
fi

# TODO: Read distribution configuration file(s)


# Build Drupal project
cd www

if [[ $PROJECT_INSTALLED == 1 ]]
then
  echo "A Drupal installation seems to be present in www/ folder, do you want to replay drush make? [y,n]"
  read MAKE_PROJECT
else
    MAKE_PROJECT='y'
fi

if [[ $MAKE_PROJECT == 'y' ]]
then
  ../bin/drush make $DISTRIBUTION_BASE_DIR/etc/distribution.make --prepare-install -y ./
fi

cd $PREVIOUS_PWD
