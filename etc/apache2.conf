# Apache2 virtual host configuration file.
<VirtualHost *:80>
  # Variables
  # =========
  #
  # The following values should be registered as variables and this file 
  # generated.
  # 
  # $server.name: main domain name
  # $server.alias: alternate domain names, separated by space
  # $server.username: owner of the Apache process
  # system.username: owner of the project files
  # project.name: the computer name of the project
  # project.root_path: absolute base directory for the project. It usually 
  # contains "system username" and "project name". Does not include trailing 
  # slash.
  # $project.tmp_path: absolute tmp path. Defaults to 
  # $project.root_path/var/tmp
  # directories: temporary, sessions, logs, ...

  # Drupal specific
  # ===============
  # 
  # The following directories are referenced as Drupal variables (in DB):
  # * file_directory_temp: defaults to /tmp in standard Drupal installation
  # * file_directory_path: defaults to sites/default/files (relative)

  # Tests
  # =====
  # 
  # Here is some notes about testing this configuration file. Assert that...:
  # 
  # * referenced directories or files exist.
  # * referenced directories are readable by the Apache user.
  # * some directories are writable by the Apache user (like www-data). It 
  #   includes the temporary directory, maybe the logs directory, the 
  #   PHP-session directory.
  # * memory_limit is lower than server's available memory
  # * upload_max_filesize is lower than or equals memory_limit
  
  ServerName $server.name
  ServerAlias $server.alias
  DocumentRoot $project.root_path/www
  LogLevel warn

  ErrorLog $project.root_path/var/log/access.log
  CustomLog $project.root_path/var/log/access.log combined

  <Directory $project.root_path/www>
    Order allow,deny
    Allow from all
    
    # TODO: restrict overrides but allow Drupal's .htaccess
    AllowOverride All

    # PHP configuration
    # =================
    #
    # See http://www.php.net/manual/en/configuration.php
    # 
    # This configuration part is meant to be generic and may be compatible with 
    # several PHP software. It mostly covers project-specific tuning. For 
    # software-specific settings, create/edit configuration sections after this 
    # one.
    # 
    # Notices:
    # * php_admin_* directives cannot be overriden in .htaccess or with 
    #   ini_set()
    # * use php_*flag rather than php_*value for booleans

    # PATHS
    php_admin_value doc_root                    "$project.root_path/www"
    # Drupal's variable_get("file_directory_temp") should be under open_basedir.
    # It defaults to /tmp/ on standard Drupal installations.
    php_admin_value open_basedir                "$project.root_path/www/:$project.tmp_path/:/tmp/"
    php_value include_path                      "$project.root_path/www"
    
    # UPLOADS
    php_admin_flag file_uploads                 on
    php_admin_value upload_tmp_dir              "$project.tmp_path"
    php_value upload_max_filesize               64M
    
    # LOGS
    php_value error_log                         "$project.root_path/var/log/php.log"
    php_flag display_errors                     on
    php_flag display_startup_errors             on
    php_flag html_errors                        on
    php_admin_flag log_errors                   on
    php_admin_flag define_syslog_variables      on
    
    # SECURITY
    php_admin_flag expose_php                   off
    php_value max_input_time                    "120"
    php_admin_flag register_globals             off
    php_admin_value variables_order             PGCSE
    php_admin_flag allow_url_fopen              on
    php_admin_flag safe_mode                    off
    php_admin_value safe_mode_allowed_env_vars  "LANG"
    php_value max_execution_time                "300"
    php_value memory_limit                      "128M"

    php_flag allow_call_time_pass_reference     on

    # TEMPORARY DIRECTORY
    # Change all directives in http://www.php.net/manual/en/ini.list.php which
    # default value is /tmp.
    # Warning: validate that these directories are under open_basedir.
    php_value axis2.log_path                    "$project.tmp_path"
    php_value session_pgsql.sem_file_name 	    "$project.tmp_path/php_session_pgsql"
    php_value soap.wsdl_cache_dir               "$project.tmp_path"
    php_value uploadprogress.file.filename_template "$project.tmp_path/upt_%s.txt"
    php_value xdebug.output_dir                 "$project.tmp_path"
    php_value xdebug.profiler_output_dir        "$project.tmp_path"
    php_value xdebug.trace_output_dir           "$project.tmp_path"
    # Change default session save path too
    php_value session.save_path                 "$project.tmp_path/sessions"

  </Directory>
</VirtualHost>
